<html>
<head><meta charset="utf-8"/><title>尬聊</title></head>
<body>
<script src="https://cdn.bootcss.com/vue/2.4.4/vue.min.js"></script>
<script src="https://cdn.bootcss.com/element-ui/1.4.6/index.js"></script>
<script src="https://cdn.bootcss.com/paho-mqtt/1.0.2/mqttws31.min.js"></script>
<link href="https://cdn.bootcss.com/element-ui/1.4.6/theme-default/index.css" rel="stylesheet">
<div>
    <el-card style="height: 100%">
        <div style="width:100%;position:absolute;bottom: 30px">
            <el-input placeholder="输入内容 Enter键发送" style="width:90%" v-model="tosend" @keyup.enter.native="send"></el-input>
        </div>
        <div id="chat" style="margin-bottom: 100px;">
            <div v-for="m in messages"><el-tag type="primary" style="margin:2px">{{m}}</el-tag></div>
        </div>
    </el-card>
</div>
<script>
    var client = new Paho.MQTT.Client("home.appxc.com", Number(10100), ""+Math.random())
    client.onMessageArrived = function(message) { window.vm.messages.push(JSON.parse(message.payloadString).content)}
    client.connect({useSSL:true, onSuccess:function(){ client.subscribe("public")}})
    window.vm=new Vue({
        el:'body>div',
        data:{messages:[], tosend:''},
        methods:{
            send:function(){
                if(this.tosend == "") return
                fetch('http://www.tuling123.com/openapi/api',opt()).then( res => {
                    res.json().then( obj => {
                        console.log(obj)
                     })})

                var payload = ({content:this.tosend})
                var message = new Paho.MQTT.Message(JSON.stringify(payload))
                message.destinationName = "public"
                client.send(message)
                this.tosend = ""
            }
        }
    })
    function opt() {
        return {
            method:"POST",
            credentials: 'include',
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
            body:JSON.stringify({
                    key:'3580c8035c924c6ea049a12240639e4a',
                    info:vm.tosend,
                    userid:client
            })
        }
    }
</script>
</body>
</html>